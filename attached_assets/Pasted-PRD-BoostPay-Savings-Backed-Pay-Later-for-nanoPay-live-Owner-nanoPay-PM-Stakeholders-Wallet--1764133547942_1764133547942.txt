PRD — BoostPay (Savings-Backed Pay Later) for nanoPay.live

Owner: nanoPay PM
Stakeholders: Wallet (PWA), Relayer, Smart-Contracts, Partners (NGOs, merchants, browsers/telcos)
Version: v1.1 (MVP→Pilot)
Context: nanoPay is a no-install PWA wallet with gasless EIP-3009 transfers, execute-by-link, x402 pay-over-HTTP, and Aave v3 auto-savings. BoostPay adds BNPL funded by the user’s own savings yield with a capped principal backstop and instant merchant settlement via an optional pool.

⸻

1) Problem & Goals

Problem. Credit access is scarce/expensive; BNPL is opaque and debt-driven; merchants need certainty; many users have weak connectivity.

Goal. Let a user lock savings, then buy now against future yield + optional top-ups, while keeping principal invested. Merchants receive cash now (via pool) or guaranteed maturity claim. UX must stay one screen + simple pay sheet, offline-tolerant, gasless.

Non-Goals (v1).
	•	Unsecured lending; complex streaming engines; multi-asset leverage; secondary markets beyond a simple pool.

⸻

2) Personas & JTBD
	•	Everyday user (low bandwidth): “Use my savings to safely pay later without touching principal.”
	•	Merchant/vendor: “Get paid now or guaranteed by a protocol I trust.”
	•	NGO/program operator: “Disburse essentials with auditability, not debt traps.”
	•	Browser/telco partner: “Embed gasless/x402 rails (WaaS) quickly.”

⸻

3) Core Concept & Terminology
	•	Savings Vault: user deposits USDC → Aave v3 (aUSDC). Tracks unlocked vs locked.
	•	pcNFT (Payment Commitment NFT): on-chain claim {buyer, merchant, amount, maturity, principalCap, scheduleHash} redeemable by merchant/pool.
	•	Instant Settlement Pool (ISP, optional): LPs buy pcNFTs at ~1–2% discount → merchant receives USDC now; pool redeems at maturity.
	•	x402: merchant surfaces Pay now / Pay later via HTTP 402 challenge; wallet replies.
	•	Execute-by-link: short URL to finalize intents in low-signal contexts (single-use, expiring).
	•	Health: coverage ratio of locked collateral + paid-so-far vs outstanding.

⸻

4) Functional Requirements

4.1 Spendable limit & health (deterministic, explainable)

Let:
	•	B_{\text{locked}}: locked savings (USDC)
	•	APY: conservative EMA estimate (net)
	•	T: tenor in years (UI supports 2–12 months; T=\tfrac{\text{months}}{12})
	•	\text{TopUps}(T): user’s planned top-ups over T (if any)
	•	Haircuts: \alpha\in[0.6,0.9],\; \beta\le0.8,\; \gamma\le1

Spendable limit at checkout
\boxed{\text{Spendable}=\alpha B_{\text{locked}}+\beta\cdot(\text{APY}\cdot B_{\text{locked}}\cdot T)\;+\;\gamma\cdot \text{TopUps}(T)\;-\;\text{Outstanding}}
(Optional compounding flag): replace linear yield with (1+\frac{\text{APY}}{12})^{12T}-1.

Health (live)
\boxed{\text{Health}=\frac{\alpha B_{\text{locked}} + Y_{\text{accrued}} + \text{TopUps}_{\text{to-date}}}{\text{Outstanding}}}
Badges: OK ≥ 1.10, Attention 1.05–1.10, Action < 1.05

Numerical sanity (common case): B_{\text{locked}}=\$1{,}000, APY=6%, T=1, \alpha=0.8, \beta=0.7 → Spendable (no top-ups) ≈ $842–$843. A $150 purchase → initial Health ≈ 5.33.

4.2 Checkout (x402 pay sheet)
	•	Tabs: Pay now | Pay later (BoostPay).
	•	If Pay later: display three levers with previews:
	1.	Top-ups plan (e.g., $7.50/mo)
	2.	Lock more savings (raises yield coverage; reduces top-ups)
	3.	Principal at maturity cap (max $ use if shortfall remains)
	•	“If APY holds” label on projections.
	•	Merchant options shown: Instant settlement (pool) or Hold to maturity.

4.3 Merchant flows
	•	Hold to maturity: pcNFT assigned to merchant; redeem(pcId) at/after maturity → Vault pays from (yield + top-ups + up to cap).
	•	Instant settlement: merchant sells pcNFT to ISP at fixed discount (v1: 1.5%). ISP redeems at maturity.

4.4 Wallet UI

New page /boostpay (one screen):
	•	Summary strip: Spendable • Locked/Unlocked • Outstanding • Next payment • Health
	•	Active purchases list: card per pcNFT: amount, merchant, maturity, health; progress split into Covered to-date (Yield + Top-ups) / Projected; Principal cap shown as a thin boundary marker. Actions: Top up, Repay now, Adjust plan, Receipt
	•	Savings module: saved, APY, Lock slider, Simulate (what-if APY/lock/tenor)
	•	Plan & Safety: top-up picker, Max principal at maturity slider, new-merchant cool-off, notifications
	•	How it works: 3 bullets (plain language)

Detail view /boostpay/:pcId: ring chart; monthly timeline; controls; receipts (pcNFT id, tx); health banners with one-tap fixes.

Home card: “Spendable $X • Outstanding $Y • Next $Z on DOW” → Open BoostPay.

4.5 Offline & low-signal
	•	All values cached (IndexedDB) with “Data ~10m old” badge.
	•	Queued actions (top-ups, lock edits) with “Pending (n) • Sync now” pill.
	•	Execute-by-link capsules for checkout finalization (claim-style by default).

4.6 Rails & gasless
	•	Primary: EIP-3009 (USDC native variants) for gasless intents (mint/lock/settle), via relayer.
	•	Fallback: ERC-4337 + paymaster (opt-in “pro mode”) for chains/tokens without 3009; unlocks session keys for scheduled top-ups/kiosks.
	•	Security defaults: allowlisted {chainId, token}, nonce DB (UNIQUE), short expiries (10–30 min), idempotent execution, cancel-path where supported.

⸻

5) Smart-Contracts (MVP)

5.1 SavingsVault.sol
	•	deposit(amount) → supply to Aave v3
	•	withdraw(amount) → from unlocked only; pre-check health (soft-lock toggle)
	•	lock(user, amount, pcId) / unlock(user, amount)
	•	creditYield(user) → epoch accounting; yieldAccrued[user]
	•	settle(pcId) → pay from yieldAccrued + topUps; at maturity use up to principalCap then mark paid
	•	Events: Locked, Unlocked, YieldCredited, Settled, TopUpReceived, SoftLockChanged

Guards: allowlisted Aave reserves; APY haircut from oracle; emergency pause.

5.2 PaymentCommitment.sol (ERC-721 pcNFT)
	•	mintPC(buyer, merchant, amount, maturity, principalCap, scheduleHash)
	•	markPaid(pcId, amount, source) (Vault-only)
	•	redeem(pcId) (merchant/ISP at/after maturity)
	•	Transferable once (merchant→ISP) to keep v1 simple.

5.3 InstantSettlementPool.sol (optional)
	•	buy(pcId) → pays amount*(1-discountBps) to merchant; receives pcNFT
	•	redeem(pcId) → claims from Vault at maturity
	•	Admin: setDiscountBps, whitelists, pause

⸻

6) Relayer, Capsules, Indexer

Relayer endpoints

POST /bnpl/mint-lock       // mint pcNFT + lock; optional sellToISP
POST /bnpl/settle          // settle/repay intent
POST /capsules             // create short-lived execute-by-link

	•	Verifies EIP-712 signatures, allowlists, nonces, expiries; returns txHash.
	•	Rate-limits per IP + from address; signed fee quotes to deter abuse.

Capsules
	•	Store signed payload server-side; SMS/QR carries only short id; single-use; TTL 10–30 min; status “pending|used|expired”.

Indexer
	•	Subscribes to Vault/pcNFT events; computes:
	•	spendable, outstanding, health
	•	shortfallAtMaturity
	•	banners (“APY dip”, “Maintenance call”)
	•	APY oracle: conservative EMA with haircut; reserve-pause awareness.

⸻

7) Data Models (client)

type VaultState = {
  saved: bigint; locked: bigint; apyEst: number; softLockEnabled: boolean;
};
type Purchase = {
  id: string; merchant: string; note?: string;
  amount: bigint; maturity: number;
  paidYield: bigint; paidTopups: bigint; principalCap: bigint;
  health: number; nextDue?: number;
};
type Derived = { outstanding: bigint; spendable: bigint; shortfallAtMaturity: bigint; };


⸻

8) UX & Copy (ship-ready snippets)
	•	Pay-later confirm: “You keep $1,000 saved. Your future earnings + top-ups will repay $150. Max principal at maturity: $90. If APY holds.”
	•	APY dip banner: “APY fell to 5.2%. Short by $9 at maturity. Fix: Add $1.50/wk or Lock +$150.”
	•	Withdraw guard: “Withdrawing $100 drops Health to 0.96. Choose a fix first.”
	•	Health badge thresholds: OK ≥1.10 • Attention 1.05–1.10 • Action <1.05

Accessibility: 44px targets; high-contrast; non-color cues (principal cap boundary); screen-reader labels (“Progress: 31% covered; 11% top-ups projected; cap line at $90”).

Intl: Intl.NumberFormat/DateTimeFormat; RTL support.

⸻

9) Non-Functional Requirements
	•	PWA footprint: +<60KB gzipped for BoostPay modules.
	•	Latency targets: Pay sheet open <400ms; mint-lock tx submission <2s (network permitting).
	•	Offline: All screens load from cache; risky actions blocked with queued badge.
	•	Security: AES-GCM key vault (IndexedDB), auto-lock; CSP strict; no key material in localStorage; relayer idempotent; contract pause switches.
	•	Privacy (optional mode): metadata minimization; per-dapp addresses; private sends later (Kohaku rail) — behind a flag.

⸻

10) Risk & Compliance
	•	Token/chain risk: USDC native variants only; reserve allowlist; depeg disclosure.
	•	Market risk: APY volatility → haircuts, maintenance calls, clear UI levers.
	•	Liquidity risk (ISP): fallback to “hold to maturity” if pool empty.
	•	Regulatory stance: secured BNPL against user savings; wallet self-custodial; KYC/AML sits at external cash-in/out partners (unchanged).

⸻

11) Telemetry & KPIs
	•	Conversion to Pay later vs Pay now; time-to-checkout.
	•	% completed with zero principal dip (target high).
	•	Median merchant settlement latency (ISP and maturity).
	•	Health distribution over lifecycle; APY-dip recovery rate.
	•	Delinquency (beyond cap) — target ~0; block new BNPL until resolved.
	•	Retention; repeat usage; savings growth.

⸻

12) Rollout Plan

Phase 0 — Prototype (≤2 weeks)
	•	Testnet (Base Sepolia or Alfajores): Vault + pcNFT (ISP optional).
	•	Relayer stubs; BoostPay route UI (summary, list, pay sheet); capsules.

Phase 1 — MVP Pilot (1 chain, 1 token)
	•	Base or Celo with native USDC; fixed ISP discount 1.5%.
	•	Small merchant/NGO pilot (100–500 users).
	•	Telemetry + banners; withdraw guard; notifications.

Phase 2 — Scale
	•	More chains/markets; dynamic ISP pricing; session keys (4337) for scheduled top-ups; privacy mode behind flag.

⸻

13) Acceptance Criteria (MVP)
	•	Create BNPL plan via pay sheet choosing any of the three lever presets; pcNFT minted; merchant either paid instantly (ISP) or can redeem at maturity.
	•	Health updates live; APY dip triggers banner with two one-tap fixes that work.
	•	Withdraw guard prevents Health <1.05 unless override with explicit confirmation.
	•	Gasless for user on supported tokens/chains; execute-by-link works once, expires correctly.
	•	Offline: pages render; actions queue; “Pending (n)” pill visible; sync unblocks when online.

⸻

14) Test Plan (high-level)
	•	Unit: formulas (Spendable/Health; compounding); suggestFix() logic; nonce/idempotency; caps.
	•	Integration: mint-lock-redeem end-to-end (merchant & ISP); APY dip → banner → fix; withdraw guard.
	•	Chaos: Aave reserve paused; oracle stalled; relayer failure; ISP empty.
	•	UX: i18n/RTL; accessibility; low-end Android perf; offline queues.

⸻

15) Open Questions
	•	ISP discount dynamic vs fixed (start fixed 1.5%; revisit after 4–6 weeks).
	•	Max tenor (proposed 12 months) — any partner constraints?
	•	Regional defaults (cool-off durations, caps, notice timing).
	•	4337 provider choice & paymaster policy (if enabled in MVP).
	•	Merchant discovery link (“Shop with BoostPay”) in v1 or v2?

⸻

16) Appendix — Example Configs (ready-to-use)
	•	Haircuts: \alpha=0.8, \beta=0.7, \gamma=1.0; MCR (maintenance) = 1.10
	•	Tenors: 2, 4, 8, 12 months
	•	ISP discount: 1.5% (v1)
	•	Caps: default principal cap = 60% of purchase (user-adjustable 0–100%)
	•	Cool-offs: new merchant = 7 days
	•	Banners: APY dip if EMA-APY falls > 20% from 30-day mean

⸻

Bottom line

BoostPay turns savings into a gentle, transparent BNPL rail: yield first, top-ups second, principal last—all with gasless UX, offline resilience, and merchant certainty. The spec above is implementable now within nanoPay’s existing rails.