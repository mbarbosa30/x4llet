# MaxFlow API Documentation

MaxFlow provides verifiable graph signals computed from endorsement graphs using max-flow/min-cut algorithms. The API returns network quality scores that applications can interpret for access control, credit scoring, governance weight, or other Sybil-resistant reputation use cases.

## Overview

### Base URL

```
https://maxflow.one/api/v1
```

### Authentication

- **Read operations** (scores, vouch status): No authentication required
- **Write operations** (vouching, revoking): Requires EIP-712 wallet signatures

### Rate Limits

200 requests per minute per IP address

### CORS

CORS is enabled for all origins. External applications can call the API directly from the browser.

## Endpoints

### GET /api/v1/score/:address

Get network quality score (0-100) for any wallet address. No authentication required.

#### Query Parameters

- **force\_refresh** (optional): Set to `true` to bypass cache and recompute the score. Default is `false`.

#### Example Requests

```
# Get cached score (default)
curl https://maxflow.one/api/v1/score/0x216844eF94D95279c6d1631875F2dd93FbBdfB61

# Force fresh computation
curl https://maxflow.one/api/v1/score/0x216844eF94D95279c6d1631875F2dd93FbBdfB61?force_refresh=true
```

#### Response

```
{
  "address": "0x216844ef94d95279c6d1631875f2dd93fbbdfb61",
  "local_health": 72,
  "cached": true,
  "cached_at": "2025-01-15T12:30:45.123Z",
  "vouch_counts": {
    "incoming_total": 8,
    "incoming_active": 7,
    "outgoing_total": 5,
    "unique_vouchers": 7
  },
  "activity": {
    "last_vouch_given_at": "2025-01-10T08:15:00.000Z"
  },
  "algorithm_breakdown": {
    "flow_component": 45.5,
    "redundancy_component": 26.5,
    "direct_flow": 7.0,
    "actual_min_cut": 5.0,
    "effective_redundancy": 12.4,
    "dilution_factor": 1.0,
    "vertex_disjoint_paths": 4,
    "ego_network_size": 15,
    "edge_density": 0.12,
    "baselines": {
      "healthy_vouch_count": 8.0,
      "healthy_redundancy": 36.0
    }
  }
}
```

#### Response Fields

- **address**: Normalized wallet address (lowercase)
- **local\_health**: Signal score 0-100 (higher = more trusted). This is the authoritative trust signal computed by the max-flow algorithm.
- **cached**: Whether the score was retrieved from cache (true) or freshly computed (false)
- **cached\_at**: Timestamp when the score was last computed (null if freshly calculated)
- **vouch\_counts.incoming\_total**: Total vouches ever received (exact count)
- **vouch\_counts.incoming\_active**: Non-expired/non-revoked vouches (from last 1,000 evaluated)
- **vouch\_counts.outgoing\_total**: Total vouches ever given (exact count)
- **vouch\_counts.unique\_vouchers**: Distinct active endorsers (from last 1,000 evaluated)
- **activity.last\_vouch\_given\_at**: When this user last vouched for someone (null if never). Used for vouch expiration calculation.

#### Algorithm Breakdown Fields

- **flow\_component**: Points from incoming trust (0-60). Based on weighted sum of voucher strengths normalized by healthy baseline.
- **redundancy\_component**: Points from true min-cut (0-40). The min-cut component measures Sybil resistance via Dinic's algorithm. (Field name retained for API compatibility.)
- **direct\_flow**: Raw max-flow value from vouchers to target. Each voucher contributes capacity weighted by their own score.
- **actual\_min\_cut**: True min-cut computed via Dinic's algorithm. Measures the minimum edges to disconnect trust sources—core Sybil resistance metric.
- **effective\_redundancy**: Combined redundancy metric = actual\_min\_cut + depth bonus + vertex-disjoint path bonus.
- **dilution\_factor**: Penalty multiplier (0.4-1.0) applied for excessive outgoing vouches. 1.0 = no penalty.
- **vertex\_disjoint\_paths**: Count of truly independent trust paths (no shared intermediate nodes).
- **ego\_network\_size**: Number of nodes in the user's extended ego subgraph (within 3 hops).
- **edge\_density**: Ratio of actual edges to potential edges in the ego subgraph. Higher = more interconnected network.
- **baselines.healthy\_vouch\_count**: Network 75th percentile vouch count (clamped 4-15). Scores scale relative to this.
- **baselines.healthy\_redundancy**: Derived redundancy baseline (healthy\_vouch\_count × 4.5). Used for redundancy normalization.

#### Ego Context (Scoring Model)

The ego context represents a wallet's personal trust network state. Each wallet has an isolated scoring context that tracks their position in the trust graph. The `local_health` score (displayed as "Signal" in the UI) measures how much the network trusts this wallet, computed using:

- **Flow Component (60%)**: Iterative PageRank-style algorithm where vouches are weighted by the voucher's own score (up to 10 iterations)
- **Min-Cut Component (40%)**: True min-cut computed via Dinic's algorithm, plus depth bonus and vertex-disjoint path bonus for Sybil resistance
- **Dilution Penalty**: Excessive outgoing vouches reduce the weight of each vouch given, ensuring accountability
- **Adaptive Baseline**: Network-wide 75th percentile vouch count (clamped 4-15) sets healthy participation thresholds

Scores are cached for 5 minutes and recalculated when a wallet gives or receives a vouch. The `cached` field indicates if the returned score is from cache; `cached_at` shows when it was last computed. Use `force_refresh=true` or the POST refresh endpoint to bypass the cache.

### GET /api/v1/scores/cached

**Bulk cached scores endpoint.** Retrieve all pre-computed LocalHealth scores from the database in a single request. This is the fastest way to get scores for multiple users - ideal for applications that need to display many scores at once.

#### Performance

This endpoint returns cached scores computed during the 6-hour network-wide recalculation cycle. **No computation occurs on request** \- it's a simple database query, typically completing in under 100ms for 500+ users.

#### Query Parameters

- **min\_score** (optional): Minimum LocalHealth score to include (default: 0)
- **limit** (optional): Maximum number of scores to return (default: 10000, max: 10000)

#### Example Requests

```
# Get all cached scores
curl https://maxflow.one/api/v1/scores/cached

# Get only scores >= 65 (likely human threshold)
curl "https://maxflow.one/api/v1/scores/cached?min_score=65"

# Get top 100 scores
curl "https://maxflow.one/api/v1/scores/cached?limit=100"
```

#### Response

```
{
  "count": 412,
  "min_score_filter": 0,
  "scores": [\
    {\
      "address": "0x216844ef94d95279c6d1631875f2dd93fbbdfb61",\
      "local_health": 72,\
      "last_updated": "2025-01-15T06:00:00.000Z"\
    },\
    {\
      "address": "0x742d35cc6634c0532925a3b844bc9e7595f0beb2",\
      "local_health": 85,\
      "last_updated": "2025-01-15T06:00:00.000Z"\
    }\
  ],
  "scheduler": {
    "last_run": "2025-01-15T06:00:00.000Z",
    "next_run": "2025-01-15T12:00:00.000Z",
    "interval_hours": 6
  },
  "note": "Scores are cached from the last network-wide computation. Use GET /api/v1/score/:address/details for on-demand detailed metrics."
}
```

#### Response Fields

- **count**: Total number of scores returned
- **min\_score\_filter**: The min\_score filter applied (0 if not specified)
- **scores**: Array of cached score objects
- **scores\[\].address**: Wallet address (lowercase)
- **scores\[\].local\_health**: Cached LocalHealth score (0-100)
- **scores\[\].last\_updated**: When this score was last computed
- **scheduler**: Information about the 6-hour recalculation scheduler
- **scheduler.last\_run**: When the last network-wide recalculation completed
- **scheduler.next\_run**: When the next recalculation is scheduled
- **scheduler.interval\_hours**: How often recalculation runs (6 hours)

#### When to Use This Endpoint

- **Displaying leaderboards or score lists** \- Fast retrieval of many scores
- **Batch verification** \- Check scores for multiple users at once
- **Analytics dashboards** \- Get aggregate score data quickly
- **Periodic syncing** \- Keep your app's cache updated every few hours

For detailed algorithm breakdown on a single user, use `GET /api/v1/score/:address/details` instead. For bulk detailed data including algorithm breakdowns, use `GET /api/v1/scores/cached/detailed`.

### GET /api/v1/scores/cached/detailed

**Bulk cached detailed scores endpoint.** Retrieve all pre-computed LocalHealth scores WITH full algorithm breakdowns in a single request. This returns the same breakdown data as the single-user details endpoint, but for all users at once.

#### Performance

Like the basic cached endpoint, this reads from the database and requires **no computation**. Algorithm breakdowns are cached during the 6-hour network-wide recalculation cycle.

#### Query Parameters

- **min\_score** (optional): Minimum LocalHealth score to include (default: 0)
- **limit** (optional): Maximum number of scores to return (default: 10000, max: 10000)

#### Example Requests

```
# Get all cached scores with detailed breakdowns
curl https://maxflow.one/api/v1/scores/cached/detailed

# Get only high-confidence users (score >= 75) with breakdowns
curl "https://maxflow.one/api/v1/scores/cached/detailed?min_score=75"

# Get top 50 scores with breakdowns
curl "https://maxflow.one/api/v1/scores/cached/detailed?limit=50"
```

#### Response

```
{
  "count": 412,
  "min_score_filter": 0,
  "scores": [\
    {\
      "address": "0x216844ef94d95279c6d1631875f2dd93fbbdfb61",\
      "local_health": 72,\
      "confidence_tier": "likely_human",\
      "flow_component": 45.5,\
      "redundancy_component": 26.5,\
      "actual_min_cut": 5.0,\
      "effective_redundancy": 12.4,\
      "vertex_disjoint_paths": 4,\
      "dilution_factor": 1.0,\
      "incoming_active": 7,\
      "outgoing_total": 5,\
      "last_updated": "2025-01-15T06:00:00.000Z"\
    }\
  ],
  "scheduler": {
    "last_run": "2025-01-15T06:00:00.000Z",
    "next_run": "2025-01-15T12:00:00.000Z",
    "interval_hours": 6
  },
  "note": "Detailed scores cached from last network-wide computation (6-hour cycle). Algorithm breakdown data is included."
}
```

#### Response Fields

- **count**: Total number of scores returned
- **scores\[\].address**: Wallet address (lowercase)
- **scores\[\].local\_health**: Final LocalHealth score (0-100)
- **scores\[\].confidence\_tier**: One of: "high\_confidence" (≥75), "likely\_human" (≥65), "uncertain" (50-64), "low\_confidence" (<50)
- **scores\[\].flow\_component**: Flow component (0-60) from incoming trust
- **scores\[\].redundancy\_component**: Redundancy/min-cut component (0-40) for Sybil resistance
- **scores\[\].actual\_min\_cut**: True min-cut computed via Dinic's algorithm
- **scores\[\].effective\_redundancy**: Combined redundancy = min-cut + depth bonus + vertex-disjoint bonus
- **scores\[\].vertex\_disjoint\_paths**: Count of truly independent trust paths
- **scores\[\].dilution\_factor**: Penalty multiplier (0.4-1.0) for excessive outgoing vouches
- **scores\[\].incoming\_active**: Number of active (non-expired, non-revoked) incoming vouches
- **scores\[\].outgoing\_total**: Total outgoing vouches given
- **scores\[\].last\_updated**: When this score was last computed

#### When to Use This Endpoint

- **Analytics and research** \- Get full algorithm data for all users at once
- **Custom scoring models** \- Use raw components to build your own thresholds
- **Network visualization** \- Display flow/redundancy breakdown across the network
- **Batch classification** \- Filter users by confidence tier in bulk

### GET /api/v1/score/:address/details

**Single-user detailed metrics endpoint.** Get comprehensive algorithm breakdown and confidence tier for one wallet address. Computes the algorithm breakdown on-demand for the most detailed analysis.

#### Performance

This endpoint computes the algorithm breakdown on-demand by running the iterative scoring algorithm. Response time is typically 1-5 seconds depending on network size. Use sparingly for individual user analysis.

#### Example Request

```
curl https://maxflow.one/api/v1/score/0x216844eF94D95279c6d1631875F2dd93FbBdfB61/details
```

#### Response

```
{
  "address": "0x216844ef94d95279c6d1631875f2dd93fbbdfb61",
  "local_health": 72,
  "cached_at": "2025-01-15T06:00:00.000Z",

  "confidence": {
    "tier": "likely_human",
    "description": "Likely human - organic redundancy detected, passes Sybil resistance checks",
    "thresholds": {
      "high_confidence": "≥75",
      "likely_human": "≥65",
      "uncertain": "50-64",
      "low_confidence": "<50"
    }
  },

  "vouch_counts": {
    "incoming_total": 8,
    "incoming_active": 7,
    "outgoing_total": 5,
    "unique_vouchers": 7
  },

  "activity": {
    "last_vouch_given_at": "2025-01-10T08:15:00.000Z"
  },

  "algorithm_breakdown": {
    "flow_component": 45.5,
    "redundancy_component": 26.5,
    "direct_flow": 7.0,
    "actual_min_cut": 5.0,
    "effective_redundancy": 12.4,
    "dilution_factor": 1.0,
    "vertex_disjoint_paths": 4,
    "ego_network_size": 15,
    "edge_density": 0.12,
    "baselines": {
      "healthy_vouch_count": 8.0,
      "healthy_redundancy": 36.0
    }
  },

  "note": "Algorithm breakdown is computed on-demand from the current network state."
}
```

#### Confidence Tiers

The confidence tier indicates how likely the wallet belongs to a real human based on validated attack pattern analysis:

- **high\_confidence (≥75)**: Almost certainly human - strong organic network with redundant trust paths. All legitimate network patterns score here.
- **likely\_human (≥65)**: Likely human - organic redundancy detected, passes Sybil resistance checks. Safe for most access control.
- **uncertain (50-64)**: Uncertain - could be a newcomer legitimately building their network OR a potential attack pattern. Consider additional verification.
- **low\_confidence (<50)**: Low confidence - matches common attack patterns (sockpuppet farms, flash mobs, Sybil rings) or very new user with minimal network.

These thresholds are derived from 51 validated test scenarios covering hub-spoke patterns, mesh networks, Sybil rings, sockpuppet farms, flash mob attacks, and more. All known attack patterns score below 55.

#### When to Use This Endpoint

- **User profile pages** \- Show detailed score breakdown to users
- **Access control decisions** \- Check confidence tier before granting privileges
- **Debugging score issues** \- Understand why a user has a particular score
- **Fraud investigation** \- Analyze algorithm components for suspicious patterns

### POST /api/v1/score/:address/refresh

Force a fresh score recalculation for a wallet. Useful when you need the most up-to-date score immediately after a vouch action.

#### Rate Limiting

**3 requests per minute per IP.** Score recalculation is computationally expensive (runs max-flow algorithm iteratively across the network). Use sparingly - the GET endpoint with caching is preferred for most use cases. Scores are automatically refreshed when vouches are created or revoked.

#### Example Request

```
curl -X POST https://maxflow.one/api/v1/score/0x216844eF94D95279c6d1631875F2dd93FbBdfB61/refresh
```

#### Response

```
{
  "address": "0x216844ef94d95279c6d1631875f2dd93fbbdfb61",
  "local_health": 72,
  "cached": false,
  "cached_at": "2025-01-15T12:30:45.123Z",
  "vouch_counts": { ... },
  "activity": { ... },
  "algorithm_breakdown": { ... },
  "refreshed": true,
  "refreshed_at": "2025-01-15T12:30:45.123Z"
}
```

Returns the same fields as GET /api/v1/score/:address plus `refreshed: true` and `refreshed_at` timestamp.

### GET /api/v1/vouch/nonce/:address

Get the current epoch and next nonce for creating a vouch signature.

#### Response

```
{
  "epoch": 0,
  "nonce": 1
}
```

### POST /api/v1/vouch

Submit a vouch using EIP-712 wallet signature.

#### Request Body

```
{
  "endorser": "0x742d35Cc...",
  "endorsee": "0x1234567...",
  "epoch": "0",
  "nonce": "1",
  "sig": "0xabcd...",
  "chainId": 1
}
```

#### EIP-712 Message Types

```
const domain = {
  name: 'MaxFlow',
  version: '1',
  chainId: 1,
};

const types = {
  Endorsement: [\
    { name: 'endorser', type: 'address' },\
    { name: 'endorsee', type: 'address' },\
    { name: 'epoch', type: 'uint64' },\
    { name: 'nonce', type: 'uint64' },\
  ],
};

const message = {
  endorser: endorserAddress,
  endorsee: endorseeAddress,
  epoch: BigInt(epoch),
  nonce: BigInt(nonce),
};
```

#### Success Response

```
{ "ok": true }
```

#### Error Responses

```
// Invalid nonce (stale - refetch nonce and retry)
{ "error": "Invalid nonce - expected 2, got 1..." }

// Duplicate vouch
{ "error": "Vouch already exists for this endorser->endorsee pair" }

// Invalid signature
{ "error": "Invalid signature - signature must be from endorser wallet" }

// Race condition (409 status)
{ "error": "Nonce already used - please get a new nonce" }
```

### GET /api/v1/vouch-status

Check if a vouch exists and its current status.

#### Query Parameters

- **endorser**: Endorser wallet address
- **endorsee**: Endorsee wallet address

#### Response Examples

```
// Active vouch
{
  "exists": true,
  "status": "active",
  "days_remaining": 67,
  "created_at": "2025-11-15T12:00:00.000Z"
}

// Expiring soon (< 30 days remaining)
{
  "exists": true,
  "status": "expiring_soon",
  "days_remaining": 12,
  "created_at": "2025-09-15T12:00:00.000Z"
}

// Expired
{
  "exists": true,
  "status": "expired",
  "days_remaining": 0,
  "created_at": "2025-06-15T12:00:00.000Z"
}

// Revoked
{
  "exists": true,
  "status": "revoked",
  "days_remaining": null,
  "created_at": "2025-11-15T12:00:00.000Z"
}

// No vouch exists
{
  "exists": false,
  "status": null,
  "days_remaining": null
}
```

Vouches are valid for 90 days from creation OR as long as the recipient remains active (vouches someone within 90 days).

### GET /api/v1/revoke/info

Get endorsement ID needed for revocation.

#### Query Parameters

- **endorser**: Endorser wallet address
- **endorsee**: Endorsee wallet address

#### Response

```
{
  "exists": true,
  "endorsement_id": 1234,
  "already_revoked": false
}
```

### POST /api/v1/revoke

Revoke a vouch using EIP-712 wallet signature.

#### Request Body

```
{
  "endorser": "0x742d35Cc...",
  "endorsee": "0x1234567...",
  "endorsementId": 1234,
  "sig": "0xabcd...",
  "chainId": 1
}
```

#### EIP-712 Revocation Types

```
const types = {
  Revocation: [\
    { name: 'endorser', type: 'address' },\
    { name: 'endorsee', type: 'address' },\
    { name: 'endorsementId', type: 'uint256' },\
  ],
};

const message = {
  endorser: endorserAddress,
  endorsee: endorseeAddress,
  endorsementId: BigInt(endorsementId),
};
```

#### Success Response

```
{ "ok": true, "revoked": true }
```

## Additional Context Endpoints

These endpoints provide additional context about users and their endorsement history.

### GET /api/endorsements

List endorsements (vouches) with optional filtering. Useful for displaying who vouched for someone.

#### Query Parameters

- **endorser** (optional): Filter by endorser address
- **endorsee** (optional): Filter by endorsee address
- **limit** (optional): Max results to return (default: 100)
- **offset** (optional): Pagination offset

#### Example Request

```
curl "https://maxflow.one/api/endorsements?endorsee=0x216844ef94d95279c6d1631875f2dd93fbbdfb61&limit=10"
```

#### Response

```
{
  "endorsements": [\
    {\
      "id": 42,\
      "communityId": 0,\
      "scope": "global",\
      "endorser": "0x742d35cc6634c0532925a3b844bc9e7595f0beb",\
      "endorsee": "0x216844ef94d95279c6d1631875f2dd93fbbdfb61",\
      "epoch": 0,\
      "nonce": 5,\
      "sig": "0x...",\
      "leafHash": "0x...",\
      "promptHash": null,\
      "note": null,\
      "createdAt": "2025-10-15T14:30:00.000Z"\
    }\
  ],
  "count": 1
}
```

#### Response Fields

- **id**: Unique endorsement identifier
- **communityId**: Community ID (0 = global graph)
- **scope**: Either "global" (community 0) or "community" (specific community)
- **endorser**: Address that gave the vouch
- **endorsee**: Address that received the vouch
- **epoch**: Epoch when vouch was created
- **sig**: EIP-712 signature
- **leafHash**: Merkle tree leaf hash for verification
- **promptHash**: Hash of community prompt (null for global vouches)
- **note**: Optional note from endorser
- **createdAt**: Timestamp when vouch was created

### GET /api/endorsements/with-status

List endorsements with expiration status for each. Shows whether vouches are active, expiring soon, expired, or revoked.

#### Query Parameters

- **endorser** (optional): Filter by endorser address
- **endorsee** (optional): Filter by endorsee address
- **limit** (optional): Max results to return

#### Example Request

```
curl "https://maxflow.one/api/endorsements/with-status?endorsee=0x216844ef94d95279c6d1631875f2dd93fbbdfb61"
```

#### Response

```
{
  "endorsements": [\
    {\
      "id": 42,\
      "communityId": 0,\
      "scope": "global",\
      "endorser": "0x742d35cc6634c0532925a3b844bc9e7595f0beb",\
      "endorsee": "0x216844ef94d95279c6d1631875f2dd93fbbdfb61",\
      "epoch": 0,\
      "nonce": 5,\
      "sig": "0x...",\
      "leafHash": "0x...",\
      "promptHash": null,\
      "note": null,\
      "createdAt": "2025-10-15T14:30:00.000Z",\
      "expirationStatus": {\
        "isValid": true,\
        "isRevoked": false,\
        "isExpired": false,\
        "expiresAt": "2026-01-13T14:30:00.000Z",\
        "daysUntilExpiration": 45\
      }\
    }\
  ],
  "count": 1
}
```

#### Expiration Status Fields

- **isValid**: Whether the vouch counts toward the endorsee's score
- **isRevoked**: Whether the endorser manually revoked this vouch
- **isExpired**: Whether the vouch has expired (90+ days old and recipient inactive)
- **expiresAt**: When the vouch will expire (null if revoked)
- **daysUntilExpiration**: Days remaining until expiration (null if revoked/expired)

### GET /api/user/:address

Get wallet profile information (display name) for an address.

#### Example Request

```
curl https://maxflow.one/api/user/0x216844ef94d95279c6d1631875f2dd93fbbdfb61
```

#### Response

```
{
  "address": "0x216844ef94d95279c6d1631875f2dd93fbbdfb61",
  "name": "Alice",
  "createdAt": "2025-09-01T10:00:00.000Z",
  "updatedAt": "2025-10-15T14:30:00.000Z"
}
```

#### 404 Response

```
{ "error": "Profile not found" }
```

Returns 404 if no profile exists for the address. Profiles are created when users set a display name.

## Endpoints Summary

| Method | Endpoint | Description |
| --- | --- | --- |
| GET | /api/v1/scores/cached | Bulk cached scores (fast) |
| GET | /api/v1/score/:address | Get Signal score |
| GET | /api/v1/score/:address/details | Detailed metrics + confidence |
| GET | /api/v1/vouch/nonce/:address | Get epoch + nonce |
| POST | /api/v1/vouch | Submit vouch |
| GET | /api/v1/vouch-status | Check vouch status |
| GET | /api/v1/revoke/info | Get endorsement ID |
| POST | /api/v1/revoke | Revoke vouch |
| GET | /api/endorsements | List endorsements |
| GET | /api/endorsements/with-status | List with expiration |
| GET | /api/user/:address | Get wallet profile |

## Best Practices

### Caching

Scores are cached server-side and update when vouches change. Client-side caching for 5-10 minutes is safe.

### Nonce Handling

If you get "Invalid nonce" or 409 errors, fetch a fresh nonce and retry.

### Address Handling

All addresses are normalized to lowercase server-side. Both checksummed and lowercase addresses are accepted.

### Epoch/Nonce Types

Both strings and numbers are accepted for epoch and nonce values (e.g., "1" or 1).

### Security

- All write operations require EIP-712 wallet signatures - no API keys needed
- Read operations are fully public and can be called from client-side JavaScript
- Use HTTPS in production for all requests
- Verify signature addresses match expected wallets before trusting responses